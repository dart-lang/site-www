language: ruby
rvm: 2.4.2

cache:
  bundler: true
  directories:
    - $HOME/.nvm
    - $HOME/.pub-cache
    - /home/site-webdev

addons:
  chrome: stable

before_install:
  - nvm install 8

jobs:
  include:
    - stage: Prep
      env: NOKOGIRI_USE_SYSTEM_LIBRARIES=true # speeds up installation of html-proofer
      script: ./scripts/travis-prep.sh

    - stage: Pre-check
      script: ./scripts/check-code.sh
    - stage: Pre-check
      script: ./scripts/analyze-and-test-examples.sh --get

    - stage: Build
      env: JEKYLL_ENV=production
      script: ./scripts/travis-build.sh

    - stage: Deploy
      script: true
      deploy:
      - provider: script
        script: ./deploy/deploy-firebase.sh
        skip_cleanup: true
        on:
          repo: dart-lang/site-www
          branch: master

    # - stage: Post-check
    #   script: deploy/check_sitemap.rb

after_script:
  # 2018-02-06: we aren't currently using the output html_proof,
  # so disable it for now.
  # - if [[ $TASK == *build* ]]; then ./deploy/html_proof.rb; fi

# Only run Travis jobs for named branches (to avoid double builds for each PR)
branches:
  only: [master, /travis-build/]
